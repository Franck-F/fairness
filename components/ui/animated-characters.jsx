'use client'

import { useState, useEffect, useRef } from 'react'

function Pupil({ size = 12, maxDistance = 5, pupilColor = '#2D2D2D', forceLookX, forceLookY }) {
  const [mouseX, setMouseX] = useState(0)
  const [mouseY, setMouseY] = useState(0)
  const pupilRef = useRef(null)

  useEffect(() => {
    const handleMouseMove = (e) => {
      setMouseX(e.clientX)
      setMouseY(e.clientY)
    }
    window.addEventListener('mousemove', handleMouseMove)
    return () => window.removeEventListener('mousemove', handleMouseMove)
  }, [])

  const calculatePosition = () => {
    if (!pupilRef.current) return { x: 0, y: 0 }
    if (forceLookX !== undefined && forceLookY !== undefined) {
      return { x: forceLookX, y: forceLookY }
    }
    const rect = pupilRef.current.getBoundingClientRect()
    const cx = rect.left + rect.width / 2
    const cy = rect.top + rect.height / 2
    const dx = mouseX - cx
    const dy = mouseY - cy
    const dist = Math.min(Math.sqrt(dx ** 2 + dy ** 2), maxDistance)
    const angle = Math.atan2(dy, dx)
    return { x: Math.cos(angle) * dist, y: Math.sin(angle) * dist }
  }

  const pos = calculatePosition()

  return (
    <div
      ref={pupilRef}
      className="rounded-full"
      style={{
        width: `${size}px`,
        height: `${size}px`,
        backgroundColor: pupilColor,
        transform: `translate(${pos.x}px, ${pos.y}px)`,
        transition: 'transform 0.1s ease-out',
      }}
    />
  )
}

function EyeBall({ size = 48, pupilSize = 16, maxDistance = 10, eyeColor = 'white', pupilColor = '#2D2D2D', isBlinking = false, forceLookX, forceLookY }) {
  const [mouseX, setMouseX] = useState(0)
  const [mouseY, setMouseY] = useState(0)
  const eyeRef = useRef(null)

  useEffect(() => {
    const handleMouseMove = (e) => {
      setMouseX(e.clientX)
      setMouseY(e.clientY)
    }
    window.addEventListener('mousemove', handleMouseMove)
    return () => window.removeEventListener('mousemove', handleMouseMove)
  }, [])

  const calculatePosition = () => {
    if (!eyeRef.current) return { x: 0, y: 0 }
    if (forceLookX !== undefined && forceLookY !== undefined) {
      return { x: forceLookX, y: forceLookY }
    }
    const rect = eyeRef.current.getBoundingClientRect()
    const cx = rect.left + rect.width / 2
    const cy = rect.top + rect.height / 2
    const dx = mouseX - cx
    const dy = mouseY - cy
    const dist = Math.min(Math.sqrt(dx ** 2 + dy ** 2), maxDistance)
    const angle = Math.atan2(dy, dx)
    return { x: Math.cos(angle) * dist, y: Math.sin(angle) * dist }
  }

  const pos = calculatePosition()

  return (
    <div
      ref={eyeRef}
      className="rounded-full flex items-center justify-center transition-all duration-150"
      style={{
        width: `${size}px`,
        height: isBlinking ? '2px' : `${size}px`,
        backgroundColor: eyeColor,
        overflow: 'hidden',
      }}
    >
      {!isBlinking && (
        <div
          className="rounded-full"
          style={{
            width: `${pupilSize}px`,
            height: `${pupilSize}px`,
            backgroundColor: pupilColor,
            transform: `translate(${pos.x}px, ${pos.y}px)`,
            transition: 'transform 0.1s ease-out',
          }}
        />
      )}
    </div>
  )
}

export function AnimatedCharacters({ isTyping = false, showPassword = false, passwordLength = 0 }) {
  const [mouseX, setMouseX] = useState(0)
  const [mouseY, setMouseY] = useState(0)
  const [isPurpleBlinking, setIsPurpleBlinking] = useState(false)
  const [isBlackBlinking, setIsBlackBlinking] = useState(false)
  const [isLookingAtEachOther, setIsLookingAtEachOther] = useState(false)
  const [isPurplePeeking, setIsPurplePeeking] = useState(false)
  const purpleRef = useRef(null)
  const blackRef = useRef(null)
  const yellowRef = useRef(null)
  const orangeRef = useRef(null)

  useEffect(() => {
    const handleMouseMove = (e) => {
      setMouseX(e.clientX)
      setMouseY(e.clientY)
    }
    window.addEventListener('mousemove', handleMouseMove)
    return () => window.removeEventListener('mousemove', handleMouseMove)
  }, [])

  // Purple blinking
  useEffect(() => {
    const getInterval = () => Math.random() * 4000 + 3000
    const scheduleBlink = () => {
      const timeout = setTimeout(() => {
        setIsPurpleBlinking(true)
        setTimeout(() => {
          setIsPurpleBlinking(false)
          scheduleBlink()
        }, 150)
      }, getInterval())
      return timeout
    }
    const t = scheduleBlink()
    return () => clearTimeout(t)
  }, [])

  // Black blinking
  useEffect(() => {
    const getInterval = () => Math.random() * 4000 + 3000
    const scheduleBlink = () => {
      const timeout = setTimeout(() => {
        setIsBlackBlinking(true)
        setTimeout(() => {
          setIsBlackBlinking(false)
          scheduleBlink()
        }, 150)
      }, getInterval())
      return timeout
    }
    const t = scheduleBlink()
    return () => clearTimeout(t)
  }, [])

  // Looking at each other when typing
  useEffect(() => {
    if (isTyping) {
      setIsLookingAtEachOther(true)
      const timer = setTimeout(() => setIsLookingAtEachOther(false), 800)
      return () => clearTimeout(timer)
    }
    setIsLookingAtEachOther(false)
  }, [isTyping])

  // Purple peeking at password
  useEffect(() => {
    if (passwordLength > 0 && showPassword) {
      const schedulePeek = () => {
        const timeout = setTimeout(() => {
          setIsPurplePeeking(true)
          setTimeout(() => setIsPurplePeeking(false), 800)
        }, Math.random() * 3000 + 2000)
        return timeout
      }
      const t = schedulePeek()
      return () => clearTimeout(t)
    }
    setIsPurplePeeking(false)
  }, [passwordLength, showPassword, isPurplePeeking])

  const calculatePosition = (ref) => {
    if (!ref.current) return { faceX: 0, faceY: 0, bodySkew: 0 }
    const rect = ref.current.getBoundingClientRect()
    const centerX = rect.left + rect.width / 2
    const centerY = rect.top + rect.height / 3
    const dx = mouseX - centerX
    const dy = mouseY - centerY
    const faceX = Math.max(-15, Math.min(15, dx / 20))
    const faceY = Math.max(-10, Math.min(10, dy / 30))
    const bodySkew = Math.max(-6, Math.min(6, -dx / 120))
    return { faceX, faceY, bodySkew }
  }

  const purplePos = calculatePosition(purpleRef)
  const blackPos = calculatePosition(blackRef)
  const yellowPos = calculatePosition(yellowRef)
  const orangePos = calculatePosition(orangeRef)

  const hidingEyes = passwordLength > 0 && showPassword

  return (
    <div className="relative flex items-end justify-center h-[400px]">
      <div className="relative" style={{ width: '550px', height: '400px' }}>
        {/* Purple tall character */}
        <div
          ref={purpleRef}
          className="absolute bottom-0 transition-all duration-700 ease-in-out"
          style={{
            left: '70px',
            width: '180px',
            height: (isTyping || (passwordLength > 0 && !showPassword)) ? '440px' : '400px',
            backgroundColor: '#4A5568',
            borderRadius: '10px 10px 0 0',
            zIndex: 1,
            transform: hidingEyes
              ? 'skewX(0deg)'
              : (isTyping || (passwordLength > 0 && !showPassword))
                ? `skewX(${(purplePos.bodySkew || 0) - 12}deg) translateX(40px)`
                : `skewX(${purplePos.bodySkew || 0}deg)`,
            transformOrigin: 'bottom center',
          }}
        >
          <div
            className="absolute flex gap-8 transition-all duration-700 ease-in-out"
            style={{
              left: hidingEyes ? '20px' : isLookingAtEachOther ? '55px' : `${45 + purplePos.faceX}px`,
              top: hidingEyes ? '35px' : isLookingAtEachOther ? '65px' : `${40 + purplePos.faceY}px`,
            }}
          >
            <EyeBall size={18} pupilSize={7} maxDistance={5} isBlinking={isPurpleBlinking}
              forceLookX={hidingEyes ? (isPurplePeeking ? 4 : -4) : isLookingAtEachOther ? 3 : undefined}
              forceLookY={hidingEyes ? (isPurplePeeking ? 5 : -4) : isLookingAtEachOther ? 4 : undefined}
            />
            <EyeBall size={18} pupilSize={7} maxDistance={5} isBlinking={isPurpleBlinking}
              forceLookX={hidingEyes ? (isPurplePeeking ? 4 : -4) : isLookingAtEachOther ? 3 : undefined}
              forceLookY={hidingEyes ? (isPurplePeeking ? 5 : -4) : isLookingAtEachOther ? 4 : undefined}
            />
          </div>
        </div>

        {/* Dark character */}
        <div
          ref={blackRef}
          className="absolute bottom-0 transition-all duration-700 ease-in-out"
          style={{
            left: '240px',
            width: '120px',
            height: '310px',
            backgroundColor: '#6B5B73',
            borderRadius: '8px 8px 0 0',
            zIndex: 2,
            transform: hidingEyes
              ? 'skewX(0deg)'
              : isLookingAtEachOther
                ? `skewX(${(blackPos.bodySkew || 0) * 1.5 + 10}deg) translateX(20px)`
                : (isTyping || (passwordLength > 0 && !showPassword))
                  ? `skewX(${(blackPos.bodySkew || 0) * 1.5}deg)`
                  : `skewX(${blackPos.bodySkew || 0}deg)`,
            transformOrigin: 'bottom center',
          }}
        >
          <div
            className="absolute flex gap-6 transition-all duration-700 ease-in-out"
            style={{
              left: hidingEyes ? '10px' : isLookingAtEachOther ? '32px' : `${26 + blackPos.faceX}px`,
              top: hidingEyes ? '28px' : isLookingAtEachOther ? '12px' : `${32 + blackPos.faceY}px`,
            }}
          >
            <EyeBall size={16} pupilSize={6} maxDistance={4} isBlinking={isBlackBlinking}
              forceLookX={hidingEyes ? -4 : isLookingAtEachOther ? 0 : undefined}
              forceLookY={hidingEyes ? -4 : isLookingAtEachOther ? -4 : undefined}
            />
            <EyeBall size={16} pupilSize={6} maxDistance={4} isBlinking={isBlackBlinking}
              forceLookX={hidingEyes ? -4 : isLookingAtEachOther ? 0 : undefined}
              forceLookY={hidingEyes ? -4 : isLookingAtEachOther ? -4 : undefined}
            />
          </div>
        </div>

        {/* Orange semi-circle */}
        <div
          ref={orangeRef}
          className="absolute bottom-0 transition-all duration-700 ease-in-out"
          style={{
            left: '0px',
            width: '240px',
            height: '200px',
            zIndex: 3,
            backgroundColor: '#7D8E8C',
            borderRadius: '120px 120px 0 0',
            transform: hidingEyes ? 'skewX(0deg)' : `skewX(${orangePos.bodySkew || 0}deg)`,
            transformOrigin: 'bottom center',
          }}
        >
          <div
            className="absolute flex gap-8 transition-all duration-200 ease-out"
            style={{
              left: hidingEyes ? '50px' : `${82 + (orangePos.faceX || 0)}px`,
              top: hidingEyes ? '85px' : `${90 + (orangePos.faceY || 0)}px`,
            }}
          >
            <Pupil size={12} maxDistance={5} forceLookX={hidingEyes ? -5 : undefined} forceLookY={hidingEyes ? -4 : undefined} />
            <Pupil size={12} maxDistance={5} forceLookX={hidingEyes ? -5 : undefined} forceLookY={hidingEyes ? -4 : undefined} />
          </div>
        </div>

        {/* Yellow tall character */}
        <div
          ref={yellowRef}
          className="absolute bottom-0 transition-all duration-700 ease-in-out"
          style={{
            left: '310px',
            width: '140px',
            height: '230px',
            backgroundColor: '#C4956A',
            borderRadius: '70px 70px 0 0',
            zIndex: 4,
            transform: hidingEyes ? 'skewX(0deg)' : `skewX(${yellowPos.bodySkew || 0}deg)`,
            transformOrigin: 'bottom center',
          }}
        >
          <div
            className="absolute flex gap-6 transition-all duration-200 ease-out"
            style={{
              left: hidingEyes ? '20px' : `${52 + (yellowPos.faceX || 0)}px`,
              top: hidingEyes ? '35px' : `${40 + (yellowPos.faceY || 0)}px`,
            }}
          >
            <Pupil size={12} maxDistance={5} forceLookX={hidingEyes ? -5 : undefined} forceLookY={hidingEyes ? -4 : undefined} />
            <Pupil size={12} maxDistance={5} forceLookX={hidingEyes ? -5 : undefined} forceLookY={hidingEyes ? -4 : undefined} />
          </div>
          <div
            className="absolute w-20 h-[4px] bg-[#2D2D2D] rounded-full transition-all duration-200 ease-out"
            style={{
              left: hidingEyes ? '10px' : `${40 + (yellowPos.faceX || 0)}px`,
              top: hidingEyes ? '88px' : `${88 + (yellowPos.faceY || 0)}px`,
            }}
          />
        </div>
      </div>
    </div>
  )
}
